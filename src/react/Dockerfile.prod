# ==========================================
# Dockerfile para PRODUÃ‡ÃƒO - Apenas Build
# Sem Nginx interno (usando Nginx da VPS)
# ==========================================

FROM node:23-slim

WORKDIR /app

# Copiar arquivos de dependÃªncias primeiro (para cache layer)
COPY projeto/package*.json ./
COPY projeto/bun.lockb ./

# Instalar TODAS as dependÃªncias (incluindo devDependencies para o build)
RUN npm ci && \
    npm cache clean --force

# Copiar cÃ³digo fonte completo
COPY projeto/ ./

# Verificar se todos os arquivos necessÃ¡rios estÃ£o presentes
RUN if [ ! -f "src/lib/utils.ts" ]; then \
        echo "Criando arquivo utils.ts..." && \
        mkdir -p src/lib && \
        echo 'import { clsx, type ClassValue } from "clsx"; import { twMerge } from "tailwind-merge"; export function cn(...inputs: ClassValue[]) { return twMerge(clsx(inputs)); }' > src/lib/utils.ts; \
    fi

# Build da aplicaÃ§Ã£o
ARG VITE_API_URL
ARG NODE_ENV=production
ENV NODE_ENV=production

# FORÃ‡A BUILD DE PRODUÃ‡ÃƒO
RUN echo "ðŸ”¥ FORÃ‡ANDO BUILD DE PRODUÃ‡ÃƒO..." && \
    rm -rf dist/ && \
    NODE_ENV=production npm run build && \
    echo "âœ… Build concluÃ­do!" && \
    ls -la dist/ && \
    echo "ðŸ“‹ Verificando index.html do build:" && \
    head -5 dist/index.html

# Expor porta temporÃ¡ria para servir arquivos durante deploy
EXPOSE 5173

# Instalar servidor simples para servir arquivos durante o deploy
RUN npm install -g serve

# Servir arquivos estÃ¡ticos temporariamente
CMD ["serve", "-s", "dist", "-l", "5173"]
