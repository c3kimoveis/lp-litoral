# ==========================================
# Configuração Nginx para VPS
# LP Carneiros V2.1 - React SPA
# Domínio: carneiros.c3kimoveis.com.br
# IP: 145.223.29.235
# ==========================================

server {
    listen 80;
    server_name carneiros.c3kimoveis.com.br www.carneiros.c3kimoveis.com.br 145.223.29.235;
    
    # Caminho para os arquivos estáticos usando link simbólico
    root /app/carneiros.c3kimoveis.com.br;  # Link simbólico que aponta para versão atual
    index index.html;

    # ========== MIME Types Fix para Vite/React ==========
    location ~* \.(js|mjs)$ {
        add_header Content-Type application/javascript;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    location ~* \.(ts|tsx)$ {
        add_header Content-Type application/javascript;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    location ~* \.(css)$ {
        add_header Content-Type text/css;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    location ~* \.(json)$ {
        add_header Content-Type application/json;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # Catch-all para arquivos em /src/ (modo desenvolvimento)
    location ~* ^/src/.*\.(js|mjs|jsx|ts|tsx)$ {
        add_header Content-Type application/javascript;
        add_header Cache-Control "no-cache";
        access_log off;
    }

    # ========== Security Headers ==========
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;" always;

    # ========== Gzip Compression ==========
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        image/svg+xml;

    # ========== Cache Headers Otimizados ==========
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Garantir MIME types corretos para assets
        location ~* /assets/.*\.(js|mjs)$ {
            add_header Content-Type application/javascript;
        }
        location ~* /assets/.*\.css$ {
            add_header Content-Type text/css;
        }
    }

    # ========== SPA Routing ==========
    location / {
        try_files $uri $uri/ /index.html;

        # Garantir MIME type correto para index.html
        location = /index.html {
            add_header Content-Type text/html;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # Cache para HTML (sem cache para permitir atualizações)
        if ($uri ~ \.html$) {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
    }    # ========== Health Check ==========
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ========== Error Pages ==========
    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;

    # ========== Logs ==========
    access_log /var/log/nginx/lp-carneiros-access.log;
    error_log /var/log/nginx/lp-carneiros-error.log warn;
}

# ========== HTTPS Server Block (para produção com SSL) ==========
server {
    server_name carneiros.c3kimoveis.com.br www.carneiros.c3kimoveis.com.br;

    # Caminho para os arquivos estáticos usando link simbólico
    root /app/carneiros.c3kimoveis.com.br;  # Link simbólico que aponta para versão atual
    index index.html;

    # ========== Security Headers ==========
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;" always;

    # ========== Gzip Compression ==========
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        image/svg+xml;

    # ========== MIME Types Fix para Vite/React ==========
    location ~* \.(js|mjs)$ {
        add_header Content-Type application/javascript;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    location ~* \.(ts|tsx)$ {
        add_header Content-Type application/javascript;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    location ~* \.(css)$ {
        add_header Content-Type text/css;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    location ~* \.(json)$ {
        add_header Content-Type application/json;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # Catch-all para arquivos em /src/ (modo desenvolvimento)
    location ~* ^/src/.*\.(js|mjs|jsx|ts|tsx)$ {
        add_header Content-Type application/javascript;
        add_header Cache-Control "no-cache";
        access_log off;
    }

    # ========== Cache Headers Otimizados ==========
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Garantir MIME types corretos para assets
        location ~* /assets/.*\.(js|mjs)$ {
            add_header Content-Type application/javascript;
        }
        location ~* /assets/.*\.css$ {
            add_header Content-Type text/css;
        }
    }

    # ========== SPA Routing ==========
    location / {
        try_files $uri $uri/ /index.html;

        # Garantir MIME type correto para index.html
        location = /index.html {
            add_header Content-Type text/html;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # Cache para HTML (sem cache para permitir atualizações)
        if ($uri ~ \.html$) {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
    }

    # ========== Health Check ==========
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ========== Error Pages ==========
    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;

    # ========== Logs ==========
    access_log /var/log/nginx/lp-carneiros-access.log;
    error_log /var/log/nginx/lp-carneiros-error.log warn;

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/carneiros.c3kimoveis.com.br/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/carneiros.c3kimoveis.com.br/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

# ========== HTTP Redirect para HTTPS ==========
server {
    if ($host = carneiros.c3kimoveis.com.br) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name carneiros.c3kimoveis.com.br www.carneiros.c3kimoveis.com.br;
    return 404; # managed by Certbot
}
}